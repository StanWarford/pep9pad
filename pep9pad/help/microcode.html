<!DOCTYPE HTML PUBLIC "-//W3C/DTD HTML 4.01//EN">

<html>
<head>
 <title> Pep/9 CPU: Microcode Use </title>
  <style type="text/css" media="all">
   img { vertical-align:text-top; }
   code { font-family:Courier, 'Courier New', monospace; font-size:11pt }
  </style>
</head>
<body bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#000033" alink="#0066FF">
<table bgcolor="#FB9F14" width="100%" cellpadding="2" cellspacing="0" border="0">
<tr><td>
<p style="text-align:center; font-family:helvetica, arial, sans-serif; font-size:14pt; font-weight:bold; color: #29315E">
Microcode Use
</p>
</td></tr>
</table>
<p>
A microprogram consists of a sequence of microcode statements, which, when executed, implement
a single ISA3 instruction.
To test an implementation of an ISA3 instruction, you can manually set initial values
in memory and the CPU interactively, set the control signals for each individual cycle,
then inspect the state of the machine after the last cycle as described in the section Interactive Use.
<p>
Alternatively, you can write a microprogram in the Microcode pane, invoke the microassembler
to translate the microprogram to binary, then execute the sequence.
One advantage of writing a microprogram is the built-in unit test facility of the microassembler.
<p>
<a name = "Topics">Topics:</a>
<a href="#Writing">Writing a microprogram</a>,
<a href="#Unit">Unit tests</a>,
<a href="#Running">Running a microprogram</a>,

<h3><a name="Writing">Writing a microprogram</a></h3>
Three features of Pep/9 CPU help you write microprograms &mdash; automatic code generation, automatic un/commenting,
and automatic formatting.
<p>
<h4>Automatic code generation</h4>
One way to write a microprogram is to simply enter the text in the Microcode pane.
However, you may prefer to enter a microcode statement with a minimum of typing.
Simply set the control signals for the statement with the input widgets in the CPU pane
and then click the Copy to Microcode button.
For example, suppose you are at the following point writing your program.
<p>
<img src="qrc:/help/images/copycode1.png" alt="copycode1" hspace=10 vspace=10>
<p>
You could enter this text on the keyboard
<pre>
A=6, B=7; MARCk
</pre>
for the next cycle.
However, instead of typing the text you can interactively make the settings in the CPU pane.
In the following figure, the user has entered 6 for control signal A, 7 for control signal B, and checked the MARCk
check box.
The user can see that data is on the ABus and BBus because they are colored solid red, and that data from them will be clocked into the MAR because the
line from the MARCk checkbox is solid black instead of gray.
<p>
<img src="qrc:/help/images/copycode2.png" alt="copycode2" hspace=10 vspace=10>
<p>
At this point, the user clicks the Copy to Microcode button.
<p>
<img src="qrc:/help/images/copycode3.png" alt="copycode3" hspace=10 vspace=10>
<p>
The effect is that the microcode text corresponding to the settings in the CPU pane is generated and inserted
in the microcode pane as the following figure shows.
<p>
<img src="qrc:/help/images/copycode4.png" alt="copycode4" hspace=10 vspace=10>
<p>
<h4>Automatic un/commenting</h4>
The automatic un/commenting feature allows you comment and uncomment a group of contiguous lines of code.
For example, suppose you have entered the follwing lines of code in the Microcode pane.
<p>
<img src="qrc:/help/images/comment1.png" alt="comment1" hspace=10 vspace=10>
<p>
To comment the first two lines of code, first select them with the editor.
Any line that is partially selected will be affected by the operation.
In the following figure, the first line is completely selected and the second line is partially selected.
The second line will also be affected by the automatic comment operation.
<p>
<img src="qrc:/help/images/comment2.png" alt="comment2" hspace=10 vspace=10>
<p>
Now, select Edit->Un/Comment from the main menu, or press the equivalent keyboard shortcut for your platform.
<p>
<img src="qrc:/help/images/comment3.png" alt="comment3" hspace=10 vspace=10>
<p>
Any selected lines that are uncommented will be commented, and any selected lines that are commented will be uncommented.
<p>
<img src="qrc:/help/images/comment4.png" alt="comment4" hspace=10 vspace=10>
<p>
A handy feature of this tool is when a microprogram has more than one unit test.
In such cases, the first unit test is usually uncommented and the remaining tests are commented.
You can comment the first unit test and uncomment the second unit test in one operation by selecting <i>both</i> tests.
<p>
<img src="qrc:/help/images/comment5.png" alt="comment5" hspace=10 vspace=10>
<p>
When you perform the operation, the first test is commented and the second test is uncommented.
<p>
<img src="qrc:/help/images/comment6.png" alt="comment6" hspace=10 vspace=10>
<p>
<h4>Automatic formatting</h4>
Once you run your program so that an object code listing appears in the Object Code pane,
you can format your code with a standard formatting style.
For example, suppose you write the following microcode program in the editor.
<p>
<img src="qrc:/help/images/formatfromobject2.png" alt="formatfromobject2" hspace=10 vspace=10>
<p>
After you run the program and determine that it is correct, the binary object code is stored inside the app.
Now, select Edit->Format From Object Code from the menu.
<p>
<img src="qrc:/help/images/formatfromobject.png" alt="formatfromobject" hspace=10 vspace=10>
<p>
Your source code will be replaced with standard formatted source code extracted from the object code.
<p>
<img src="qrc:/help/images/formatfromobject4.png" alt="formatfromobject4" hspace=10 vspace=10>
<p>
<a href="#Topics">Scroll to topics</a>.
<p>
<h3><a name="Unit">Unit tests</a></h3>
To establish a unit test for your program write the unit test precondition with the <code>UnitPre</code>
keyword and the unit test postcondition with the <code>UnitPost</code> keyword
at the beginning of a line and followed by a colon <code>:</code> .
The <code>UnitPre</code> statement clears all memory and CPU vaules to zero
then sets values in memory and the CPU before the first microcode statement executes.
The <code>UnitPost</code> statement tests whether a memory cell or CPU register has a specified value
after the last microcode statement executes.
If a unit test fails, an error message is displayed in the Microcode pane, as in the following figure.
<p>
<img src="qrc:/help/images/postconditionerror.png" alt="postconditionerror" hspace=10 vspace=10>
<p>
There can be as many <code>UnitPre</code> and <code>UnitPost</code> statements as you like placed anywhere in the microprogram
listing without affecting the unit test.
However, the convention is to place the <code>UnitPre</code> statements followed by the <code>UnitPost</code> statements
before the first cycle statement in the microprogram.
<h4>Specifying register values</h4>
The instruction register IR is a three-byte register.
If you specify
<pre>
IR=0xa
</pre>
the value stored in <code>UnitPre</code> or tested in <code>UnitPost</code> is
<pre>
IR=0x00000a
</pre>
The instruction register T1 is a one-byte register.
If you specify
<pre>
T1=0xabc
</pre>
you will get the error message
<pre>
// ERROR: Hexidecimal register value is out of range (0x00..0xFF).
</pre>
All other registers in the register bank except IR and T1 are two-byte registers.
For example, if you specify <code>PC=0x12345</code> you will get an out-of-range message,
and if you specify <code>PC=0x1</code> the value 0x0001 will be stored or tested.
<p>
The NZVC bits are one-bit registers.
For example, <code>N=1</code> is a valid specification.
Although the specification <code>N=0</code> is technically not necessary in <code>UnitPre</code> because all register values are cleared
to zero before applying unit preconditions, such a specification is valid and somtimes included for emphasis.
<h4>Specifying memory values</h4>
Pep/9 main memory is byte addressable.
For example, if you specify
<pre>
Mem[0x1234]=0x5
</pre>
the one-byte value 0x05 at memory address 0x1234 is set or tested.
<p>
It is frequently necessary to specify two adjacent bytes in memory, as with the following specification.
<pre>
Mem[0xabcd]=0x11, Mem[0xabce]=0x22
</pre>
You can specify a two-byte value for adjacent memory cells by writing a single value in the range 0x0100..0xffff.
For example, you can write the above specification as
<pre>
Mem[0xabcd]=0x1122
</pre>
<a href="#Topics">Scroll to topics</a>.
<p>
<h3><a name="Running">Running a microprogram</a></h3>
After writing a microcode program in the Micorocode pane, there are two ways to execute the program.
You can run the program or you can debug it step by step.
See the section Debugging Use for how to debug your microprogram.
<h4>Running a program</h4>
The first way to execute a program is to select System->Run from the menu or click the corresponding Run icon on the toolbar.
<p>
<img src="qrc:/help/images/runmenu.png" alt="runmenu" hspace=10 vspace=10>
<img src="qrc:/help/images/runicon.png" alt="runicon" hspace=10 vspace=10>
<p>
Pep/9 CPU will attempt to microassemble your microcode program.
If there are errors, they will appear in red in the Microcode pane.
The following figure shows the error message that appears when a comma is omitted after the first control signal.
<p>
<img src="qrc:/help/images/errormessage.png" alt="errormessage" hspace=10 vspace=10>
<p>
If you would like, you can select Edit->Remove Error Messages from the menu to delete the error message.
Then, you can correct your error and try to run your program again.
<p>
<img src="qrc:/help/images/removeerrormessages.png" alt="removeerrormessages" hspace=10 vspace=10>
<p>
It is not necessary to remove the error message before correcting your program, as error messages
are automatically removed when you rerun your program.
If there are no errors, the translated program will be stored in the app and the microcode sequence will
execute.

<p>
<a href="#Topics">Scroll to topics</a>.
<p>

</body>
</html>
